<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem e-Sijil JPN Melaka</title>
	
	<link rel="icon" type="image/png" href="https://i.postimg.cc/jdp3yqpZ/logotech.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Guna fon Oswald sebagai default */
        body {
            font-family: 'Oswald', sans-serif;
            background-color: #f9fafb;
        }

        .gradient-bg {
            background: linear-gradient(90deg, #2563eb, #7c3aed);
        }

        .tab-button {
            font-size: 1.05rem;
        }

        .tab-button.active {
            border-bottom: 4px solid #facc15;
            color: #1f2937;
            font-weight: 700;
            background-color: #ffffff;
        }

        .tab-content {
            min-height: 400px;
        }

        .input-label {
            font-weight: 500;
            color: #374151;
        }

        .input-field {
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1rem;
            width: 100%;
            outline: none;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
        }

        .primary-button {
            background-color: #2563eb;
            color: #ffffff;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            transition: transform 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
        }

        .primary-button:hover {
            background-color: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.25);
        }

        .primary-button:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .card {
            border-radius: 1rem;
            background-color: #ffffff;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
            border: 1px solid #e5e7eb;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-blue {
            background-color: #dbeafe;
            color: #1d4ed8;
        }

        .badge-green {
            background-color: #dcfce7;
            color: #15803d;
        }

        .badge-amber {
            background-color: #fef3c7;
            color: #92400e;
        }

        .badge-red {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        /* Styling untuk sijil */
        #sijil-container {
            width: 100%;
            max-width: 900px;
            aspect-ratio: 4 / 3;
            position: relative;
            margin: 0 auto;
            background-color: #f3f4f6;
            border-radius: 1rem;
            overflow: hidden;
        }

        #sijil-background {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #nama-atas-sijil {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            text-transform: uppercase;
        }

        #nokp-atas-sijil {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            text-align: center;
            font-size: 1.2rem;
            color: #374151;
        }

        @media (max-width: 768px) {
            #nama-atas-sijil {
                font-size: 1.5rem;
            }
            #nokp-atas-sijil {
                font-size: 1rem;
            }
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">
    <header class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4 md:py-5 flex flex-col md:flex-row items-center justify-between gap-3">
            <div class="flex items-center gap-3">
                <img src="https://i.postimg.cc/jdp3yqpZ/logotech.png" alt="Logo" class="w-12 h-12 rounded-full shadow-md">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold tracking-wide">Sistem e-Sijil JPN Melaka</h1>
                    <p class="text-xs md:text-sm text-blue-100">
                        Pengesahan Kehadiran & Penjanaan Sijil Automatik
                    </p>
                </div>
            </div>
            <div class="flex flex-col items-end text-xs md:text-sm">
                <span class="badge badge-amber mb-1">
                    Versi Beta
                </span>
                <span class="text-blue-100">
                    Dibangunkan oleh Unit ICT JPN Melaka
                </span>
            </div>
        </div>

        <nav class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto flex flex-col md:flex-row">
                <button id="tab-btn-1" class="tab-button flex-1 py-3 px-4 text-center text-gray-600 hover:bg-gray-50 focus:outline-none transition duration-150 ease-in-out active">
                    Arahan
                </button>
                <button id="tab-btn-2" class="tab-button flex-1 py-3 px-4 text-center text-gray-600 hover:bg-gray-50 focus:outline-none transition duration-150 ease-in-out">
                    Daftar Kehadiran
                </button>
                <button id="tab-btn-3" class="tab-button flex-1 py-3 px-4 text-center text-gray-600 hover:bg-gray-50 focus:outline-none transition duration-150 ease-in-out">
                    Semak & Cetak Sijil
                </button>
                <button id="tab-btn-4" class="tab-button flex-1 py-3 px-4 text-center text-gray-600 hover:bg-gray-50 focus:outline-none transition duration-150 ease-in-out hidden md:flex">
                    Rumusan
                </button>
            </div>
        </nav>
    </header>

    <main class="flex-1">
        <div class="max-w-7xl mx-auto px-4 py-6 md:py-8">
            <div class="card p-6 md:p-8">
                
                <div id="tab-content-1" class="tab-content space-y-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Selamat Datang!</h2>
                    
                    <div>
                        <h3 class="text-xl font-bold mb-3">üìú Cara Dapatkan Sijil Anda</h3>
                        <ol class="list-decimal list-inside space-y-2 pl-4 text-gray-700">
                            <li>Pergi ke tab <strong>Daftar Kehadiran</strong>.</li>
                            <li>Isi nama penuh, No KP, peranan dan sekolah (jika berkaitan).</li>
                            <li>Pastikan maklumat tepat sebelum hantar.</li>
                            <li>Selepas berjaya daftar, anda boleh semak sijil di tab <strong>Semak & Cetak Sijil</strong>.</li>
                        </ol>
                    </div>

                    <div>
                        <h3 class="text-xl font-bold mb-3">‚ÑπÔ∏è Maklumat Penting</h3>
                        <ul class="list-disc list-inside space-y-2 pl-4 text-gray-700">
                            <li>No KP digunakan untuk semakan dan penjanaan sijil.</li>
                            <li>Jika anda salah isi maklumat, buat semula pendaftaran dengan No KP yang sama. Sistem akan kemas kini rekod anda secara automatik.</li>
                            <li>Sijil boleh dicetak dalam bentuk PDF melalui pelayar anda.</li>
                        </ul>
                    </div>
                </div>

                
                <div id="tab-content-2" class="tab-content hidden space-y-6">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Daftar Kehadiran</h2>

                    <form id="form-pendaftaran" class="space-y-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="nama" class="input-label block mb-1">Nama Penuh</label>
                                <input type="text" id="nama" class="input-field" placeholder="Contoh: AHMAD BIN ALI" required>
                            </div>
                            <div>
                                <label for="nokp" class="input-label block mb-1">No Kad Pengenalan</label>
                                <input type="text" id="nokp" class="input-field" placeholder="Tanpa tanda '-'" required>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="peranan" class="input-label block mb-1">Peranan</label>
                                <select id="peranan" class="input-field" required>
                                    <option value="">Pilih peranan anda</option>
                                    <option value="GURU">GURU</option>
                                    <option value="PENGETUA / GURU BESAR">PENGETUA / GURU BESAR</option>
                                    <option value="PPD JPN KPM">PPD JPN KPM</option>
                                    <option value="PENSYARAH IPG">PENSYARAH IPG</option>
                                    <option value="PENSYARAH IPTA/S">PENSYARAH IPTA/S</option>
                                    <option value="PENSYARAH SWASTA">PENSYARAH SWASTA</option>
                                    <option value="PELAJAR IPG">PELAJAR IPG</option>
                                    <option value="PELAJAR IPTA/S">PELAJAR IPTA/S</option>
                                    <option value="PELAJAR SWASTA">PELAJAR SWASTA</option>
                                    <option value="GURU PENDIDIKAN KHAS">GURU PENDIDIKAN KHAS</option>
                                    <option value="GURU PRASEKOLAH">GURU PRASEKOLAH</option>
                                    <option value="GURU KAUNSELING">GURU KAUNSELING</option>
                                    <option value="GURU MEDIA">GURU MEDIA</option>
                                    <option value="GURU PEMULIHAN KHAS">GURU PEMULIHAN KHAS</option>
                                    <option value="GURU BAHARU">GURU BAHARU</option>
                                    <option value="PEMIMPIN PENDIDIKAN">PEMIMPIN PENDIDIKAN</option>
                                    <option value="LAIN-LAIN">LAIN-LAIN</option>
                                </select>
                            </div>
                            <div>
                                <label for="sekolah" class="input-label block mb-1">Nama Sekolah / Institusi</label>
                                <input type="text" id="sekolah" class="input-field" placeholder="Jika berkaitan">
                                <p id="sekolah-helper" class="text-xs text-gray-500 mt-1">
                                    Wajib diisi jika anda seorang guru atau pemimpin sekolah.
                                </p>
                            </div>
                        </div>

                        <div class="flex justify-end">
                            <button id="submit-btn" type="submit" class="primary-button flex items-center gap-2">
                                <span id="submit-text">Hantar Pendaftaran</span>
                                <span id="submit-spinner" class="hidden animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
                            </button>
                        </div>
                    </form>

                    <div id="status-pendaftaran" class="mt-4 text-sm text-gray-600"></div>
                </div>

                
                <div id="tab-content-3" class="tab-content hidden space-y-4">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Semak & Cetak Sijil</h2>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-1 space-y-4">
                            <div>
                                <label for="semak-nokp" class="input-label block mb-1">Masukkan No KP</label>
                                <input type="text" id="semak-nokp" class="input-field" placeholder="Tanpa tanda '-'" required>
                            </div>
                            <div>
                                <label for="semak-nama" class="input-label block mb-1">Atau Nama Penuh</label>
                                <input type="text" id="semak-nama" class="input-field" placeholder="Jika tidak ingat No KP">
                            </div>
                            <div class="flex gap-2">
                                <button id="semak-btn" class="primary-button flex-1">Semak Rekod</button>
                                <button id="reset-btn" class="border border-gray-300 text-gray-700 px-4 py-2 rounded-full text-sm hover:bg-gray-50">
                                    Reset
                                </button>
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <div id="hasil-semak" class="p-4 bg-gray-50 rounded-lg border border-dashed border-gray-300 text-sm text-gray-600">
                                Tiada rekod disemak lagi. Masukkan No KP atau Nama dan tekan "Semak Rekod".
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <h3 class="text-xl font-semibold mb-3 text-gray-800">Pratonton Sijil</h3>
                        <div id="sijil-container">
                            <img id="sijil-background" src="sijil_techlym.png" alt="Latar Sijil">
                            <div id="nama-atas-sijil">NAMA PESERTA</div>
                            <div id="nokp-atas-sijil">NO KAD PENGENALAN</div>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="cetak-btn" class="primary-button">
                                Cetak / Simpan sebagai PDF
                            </button>
                        </div>
                    </div>
                </div>

                
                <div id="tab-content-4" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800">Rumusan Kehadiran</h2>
                    
                    <div id="rumusan-global-container" class="mb-8 p-6 bg-gray-50 rounded-lg shadow-inner">
                        <h3 class="text-xl font-bold mb-4">Rumusan Keseluruhan</h3>
                    </div>
                    
                    <h3 class="text-xl font-bold mb-4">Pecahan Mengikut Negeri</h3>
                    <div id="rumusan-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center text-gray-500 text-sm mt-8 mb-4">
        Hakcipta Terpelihara #TEAMjpnmelaka
    </footer>

    <script type="module">
        const SUPABASE_URL = 'https://qixtrxechyvxjdxthfrb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpeHRyeGVjaHl2eGpkeHRoZnJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzEyNDk1NDksImV4cCI6MjA3NzM0NDU0OX0.MdVzLgscebWGen-L9EhL0qnOYbZJo6kZyHoQEiRo9bw';
        
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        const POSISI_NAMA = '30%'; 

        const tabButtons = {
            btn1: document.getElementById('tab-btn-1'),
            btn2: document.getElementById('tab-btn-2'),
            btn3: document.getElementById('tab-btn-3'),
            btn4: document.getElementById('tab-btn-4'),
        };

        const tabContents = {
            content1: document.getElementById('tab-content-1'),
            content2: document.getElementById('tab-content-2'),
            content3: document.getElementById('tab-content-3'),
            content4: document.getElementById('tab-content-4'),
        };

        const formPendaftaran = document.getElementById('form-pendaftaran');
        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const submitSpinner = document.getElementById('submit-spinner');

        const namaInput = document.getElementById('nama');
        const nokpInput = document.getElementById('nokp');
        const perananSelect = document.getElementById('peranan');
        const sekolahInput = document.getElementById('sekolah');
        const statusPendaftaran = document.getElementById('status-pendaftaran');

        const senaraiNegeri = [
            'JOHOR', 'KEDAH', 'KELANTAN', 'MELAKA', 'NEGERI SEMBILAN', 'PAHANG',
            'PULAU PINANG', 'PERAK', 'PERLIS', 'SELANGOR', 'TERENGGANU',
            'SABAH', 'SARAWAK', 'W.P. KUALA LUMPUR', 'W.P. LABUAN', 'W.P. PUTRAJAYA'
        ];

        const senaraiPeranan = [
            'GURU', 'PENGETUA / GURU BESAR', 'PPD JPN KPM', 'PENSYARAH IPG',
            'PENSYARAH IPTA/S', 'PENSYARAH SWASTA', 'PELAJAR IPG', 'PELAJAR IPTA/S',
            'PELAJAR SWASTA', 'GURU PENDIDIKAN KHAS', 'GURU PRASEKOLAH',
            'GURU KAUNSELING', 'GURU MEDIA', 'GURU PEMULIHAN KHAS',
            'GURU BAHARU', 'PEMIMPIN PENDIDIKAN', 'LAIN-LAIN'
        ];

        const rumusanContainer = document.getElementById('rumusan-container');
        const rumusanGlobalContainer = document.getElementById('rumusan-global-container');

        const semakNokpInput = document.getElementById('semak-nokp');
        const semakNamaInput = document.getElementById('semak-nama');
        const semakBtn = document.getElementById('semak-btn');
        const resetBtn = document.getElementById('reset-btn');
        const hasilSemakContainer = document.getElementById('hasil-semak');
        const cetakBtn = document.getElementById('cetak-btn');

        const sijilContainer = document.getElementById('sijil-container');
        const sijilBackground = document.getElementById('sijil-background');
        const namaAtasSijil = document.getElementById('nama-atas-sijil');
        const nokpAtasSijil = document.getElementById('nokp-atas-sijil');

        function showTab(tabIndex) {
            Object.values(tabContents).forEach(content => {
                content.classList.add('hidden');
            });

            Object.values(tabButtons).forEach(btn => {
                btn.classList.remove('active');
            });

            const selectedContent = tabContents['content' + tabIndex];
            selectedContent.classList.remove('hidden');

            const selectedBtn = tabButtons['btn' + tabIndex];
            selectedBtn.classList.add('active');

            if (tabIndex === '4') {
                loadRumusan();
            }
        }

        const perananWajibSekolah = [
            'GURU', 'PENGETUA / GURU BESAR', 'GURU PENDIDIKAN KHAS', 'GURU PRASEKOLAH',
            'GURU KAUNSELING', 'GURU MEDIA', 'GURU PEMULIHAN KHAS', 'GURU BAHARU',
            'PEMIMPIN PENDIDIKAN'
        ];

        perananSelect.addEventListener('change', () => {
            if (perananWajibSekolah.includes(perananSelect.value)) {
                sekolahInput.required = true;
                document.getElementById('sekolah-helper').classList.add('text-red-500', 'font-medium');
            } else {
                sekolahInput.required = false;
                document.getElementById('sekolah-helper').classList.remove('text-red-500', 'font-medium');
            }
        });

        formPendaftaran.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;
            submitText.textContent = 'Memproses...';
            submitSpinner.classList.remove('hidden');

            const nama = namaInput.value.trim().toUpperCase();
            const nokp = nokpInput.value.trim();
            const peranan = perananSelect.value;
            const sekolah = sekolahInput.value.trim().toUpperCase();

            if (!nama || !nokp || !peranan) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Maklumat Tidak Lengkap',
                    text: 'Sila isi Nama, No KP dan Peranan.',
                });
                submitBtn.disabled = false;
                submitText.textContent = 'Hantar Pendaftaran';
                submitSpinner.classList.add('hidden');
                return;
            }

            if (perananWajibSekolah.includes(peranan) && !sekolah) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Sekolah Wajib Diisi',
                    text: 'Untuk peranan yang dipilih, sila isi nama sekolah/institusi.',
                });
                submitBtn.disabled = false;
                submitText.textContent = 'Hantar Pendaftaran';
                submitSpinner.classList.add('hidden');
                return;
            }

            try {
                const { data, error } = await db
                    .from('peserta')
                    .upsert(
                        {
                            nama,
                            nokp,
                            peranan,
                            sekolah,
                        },
                        {
                            onConflict: 'nokp',
                        }
                    )
                    .select();

                if (error) {
                    console.error('Ralat semasa mendaftar:', error.message);
                    throw error;
                }

                statusPendaftaran.textContent = 'Pendaftaran berjaya disimpan atau dikemas kini.';
                statusPendaftaran.className = 'mt-4 text-sm text-green-600';

                Swal.fire({
                    icon: 'success',
                    title: 'Berjaya',
                    html: `
                        <p class="mb-2"><strong>${nama}</strong></p>
                        <p>Pendaftaran anda telah disimpan.</p>
                        <p class="mt-2 text-xs text-gray-500">Jika anda isi semula dengan No KP yang sama, rekod anda akan dikemas kini.</p>
                    `,
                });

                formPendaftaran.reset();
            } catch (error) {
                console.error('Ralat umum semasa pendaftaran:', error.message);
                statusPendaftaran.textContent = 'Ralat semasa pendaftaran: ' + error.message;
                statusPendaftaran.className = 'mt-4 text-sm text-red-600';

                Swal.fire({
                    icon: 'error',
                    title: 'Pendaftaran Gagal',
                    text: error.message,
                });
            } finally {
                submitBtn.disabled = false;
                submitText.textContent = 'Hantar Pendaftaran';
                submitSpinner.classList.add('hidden');
            }
        });

        semakBtn.addEventListener('click', async () => {
            const nokp = semakNokpInput.value.trim();
            const nama = semakNamaInput.value.trim().toUpperCase();

            if (!nokp && !nama) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Sila Isi No KP atau Nama',
                    text: 'Masukkan sekurang-kurangnya No KP atau Nama untuk semakan.',
                });
                return;
            }

            hasilSemakContainer.innerHTML = '<p class="text-gray-500">Memuatkan rekod...</p>';

            try {
                let query = db.from('peserta').select('*');

                if (nokp) {
                    query = query.eq('nokp', nokp);
                } else if (nama) {
                    query = query.ilike('nama', `%${nama}%`);
                }

                const { data, error } = await query;

                if (error) {
                    console.error('Ralat semasa semakan:', error.message);
                    throw error;
                }

                if (!data || data.length === 0) {
                    hasilSemakContainer.innerHTML = '<p class="text-red-500">Tiada rekod dijumpai.</p>';
                    Swal.fire({
                        icon: 'info',
                        title: 'Tiada Rekod',
                        text: 'Tiada rekod dijumpai untuk maklumat yang dimasukkan.',
                    });
                    return;
                }

                const rekod = data[0];

                hasilSemakContainer.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h4 class="text-lg font-semibold mb-2 text-gray-800">Maklumat Peserta</h4>
                        <p><span class="font-medium">Nama:</span> ${rekod.nama}</p>
                        <p><span class="font-medium">No KP:</span> ${rekod.nokp}</p>
                        <p><span class="font-medium">Peranan:</span> ${rekod.peranan}</p>
                        <p><span class="font-medium">Sekolah / Institusi:</span> ${rekod.sekolah || '-'}</p>
                    </div>
                `;

                namaAtasSijil.textContent = rekod.nama;
                nokpAtasSijil.textContent = rekod.nokp;
            } catch (error) {
                console.error('Ralat umum semasa semakan:', error.message);
                hasilSemakContainer.innerHTML = '<p class="text-red-500">Ralat semasa semakan: ' + error.message + '</p>';
                Swal.fire({
                    icon: 'error',
                    title: 'Ralat Semakan',
                    text: error.message,
                });
            }
        });

        resetBtn.addEventListener('click', () => {
            semakNokpInput.value = '';
            semakNamaInput.value = '';
            hasilSemakContainer.innerHTML = 'Tiada rekod disemak lagi. Masukkan No KP atau Nama dan tekan "Semak Rekod".';
            namaAtasSijil.textContent = 'NAMA PESERTA';
            nokpAtasSijil.textContent = 'NO KAD PENGENALAN';
        });

        cetakBtn.addEventListener('click', () => {
            window.print();
        });

        async function loadRumusan() {
            const loadingHtml = '<p class="text-gray-500">Memuatkan data rumusan...</p>';
            rumusanContainer.innerHTML = loadingHtml;
            rumusanGlobalContainer.innerHTML = loadingHtml;
            
            try {
                // Ambil semua rekod peserta secara berperingkat (atasi had 1000 rekod Supabase)
                const pageSize = 1000;
                let from = 0;
                let to = pageSize - 1;
                let allRows = [];
                let fetchMore = true;

                while (fetchMore) {
                    const { data, error } = await db
                        .from('peserta')
                        .select('negeri, peranan, nokp') // Termasuk 'nokp' untuk kiraan jantina
                        .range(from, to);

                    if (error) throw error;

                    if (!data || data.length === 0) {
                        fetchMore = false;
                    } else {
                        allRows = allRows.concat(data);

                        if (data.length < pageSize) {
                            fetchMore = false;
                        } else {
                            from += pageSize;
                            to += pageSize;
                        }
                    }
                }

                const data = allRows;

                const summaryNegeri = {};
                senaraiNegeri.forEach(negeri => {
                    summaryNegeri[negeri] = {
                        TOTAL: 0,
                        ...senaraiPeranan.reduce((obj, peranan) => {
                            obj[peranan] = 0;
                            return obj;
                        }, {}),
                        LELAKI: 0,
                        PEREMPUAN: 0,
                    };
                });

                const summaryGlobal = {
                    TOTAL: 0,
                    ...senaraiPeranan.reduce((obj, peranan) => {
                        obj[peranan] = 0;
                        return obj;
                    }, {}),
                    LELAKI: 0,
                    PEREMPUAN: 0,
                };

                data.forEach(item => {
                    const negeri = item.negeri ? item.negeri.toUpperCase() : 'LAIN-LAIN';
                    const peranan = item.peranan ? item.peranan.toUpperCase() : 'LAIN-LAIN';

                    if (!summaryNegeri[negeri]) {
                        summaryNegeri[negeri] = {
                            TOTAL: 0,
                            ...senaraiPeranan.reduce((obj, p) => {
                                obj[p] = 0;
                                return obj;
                            }, {}),
                            LELAKI: 0,
                            PEREMPUAN: 0,
                        };
                    }

                    summaryNegeri[negeri].TOTAL++;
                    summaryGlobal.TOTAL++;

                    if (summaryNegeri[negeri][peranan] !== undefined) {
                        summaryNegeri[negeri][peranan]++;
                    } else {
                        summaryNegeri[negeri]['LAIN-LAIN']++;
                    }

                    if (summaryGlobal[peranan] !== undefined) {
                        summaryGlobal[peranan]++;
                    } else {
                        summaryGlobal['LAIN-LAIN']++;
                    }

                    if (item.nokp && item.nokp.length >= 1) {
                        const digit = item.nokp[item.nokp.length - 1];
                        if (parseInt(digit) % 2 === 0) {
                            summaryNegeri[negeri].PEREMPUAN++;
                            summaryGlobal.PEREMPUAN++;
                        } else {
                            summaryNegeri[negeri].LELAKI++;
                            summaryGlobal.LELAKI++;
                        }
                    }
                });
                
                const negeriUnik = new Set(data.map(item => item.negeri));

                let globalHtml = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm font-medium text-gray-500">JUMLAH BESAR</div>
                            <div class="text-3xl font-bold text-red-600">${summaryGlobal.TOTAL}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm font-medium text-gray-500">LELAKI</div>
                            <div class="text-3xl font-bold text-blue-600">${summaryGlobal.LELAKI}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm font-medium text-gray-500">PEREMPUAN</div>
                            <div class="text-3xl font-bold text-pink-500">${summaryGlobal.PEREMPUAN}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm font-medium text-gray-500">NEGERI</div>
                            <div class="text-3xl font-bold text-green-600">${negeriUnik.size}</div>
                        </div>
                    </div>
                    <hr class="my-6 border-gray-200">
                    <h4 class="text-lg font-semibold mb-3">Pecahan Mengikut Peranan</h4>
                    <ul class="space-y-2 text-gray-700">
                        ${senaraiPeranan.map(peranan => `
                            <li class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                                <span class="font-medium">${peranan}</span>
                                <span class="font-bold text-lg text-red-600">${summaryGlobal[peranan]}</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
                rumusanGlobalContainer.innerHTML = globalHtml;

                let heatmapHtml = '';
                const maxTotal = Math.max(
                    ...Object.values(summaryNegeri).map(n => n.TOTAL),
                    1
                );

                Object.entries(summaryNegeri).forEach(([negeri, dataNegeri]) => {
                    const intensity = dataNegeri.TOTAL / maxTotal;
                    let bgColor = 'bg-gray-50';
                    if (intensity > 0.6) bgColor = 'bg-red-100';
                    else if (intensity > 0.3) bgColor = 'bg-yellow-100';
                    else if (intensity > 0) bgColor = 'bg-green-100';

                    heatmapHtml += `
                        <div class="${bgColor} p-4 rounded-lg shadow-sm border border-gray-200">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-bold text-lg text-gray-800">${negeri}</h4>
                                <span class="badge badge-blue">Total: ${dataNegeri.TOTAL}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                                <div class="bg-white p-2 rounded">
                                    <div class="text-xs text-gray-500">Lelaki</div>
                                    <div class="font-bold text-blue-600">${dataNegeri.LELAKI}</div>
                                </div>
                                <div class="bg-white p-2 rounded">
                                    <div class="text-xs text-gray-500">Perempuan</div>
                                    <div class="font-bold text-pink-600">${dataNegeri.PEREMPUAN}</div>
                                </div>
                            </div>
                            <details class="mt-2">
                                <summary class="text-xs text-gray-600 cursor-pointer">Lihat pecahan peranan</summary>
                                <ul class="mt-2 space-y-1 text-xs">
                                    ${senaraiPeranan.map(peranan => `
                                        <li class="flex justify-between bg-white px-2 py-1 rounded">
                                            <span>${peranan}</span>
                                            <span class="font-semibold">${dataNegeri[peranan]}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </details>
                        </div>
                    `;
                });

                rumusanContainer.innerHTML = heatmapHtml || '<p class="text-gray-500">Tiada data untuk dipaparkan.</p>';
            } catch (error) {
                console.error('Ralat Memuatkan Rumusan:', error.message);
                const errorHtml = `<p class="text-red-500 font-bold">Gagal memuatkan data: ${error.message}</p>`;
                rumusanContainer.innerHTML = errorHtml;
                rumusanGlobalContainer.innerHTML = errorHtml;

                Swal.fire({
                    icon: 'error',
                    title: 'Gagal Muat Rumusan',
                    text: error.message,
                });
            }
        }

        tabButtons.btn1.addEventListener('click', () => showTab('1'));
        tabButtons.btn2.addEventListener('click', () => showTab('2'));
        tabButtons.btn3.addEventListener('click', () => showTab('3'));
        tabButtons.btn4.addEventListener('click', () => showTab('4'));

        showTab('1');
    </script>
</body>
</html>
