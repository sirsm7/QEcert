<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem e-Sijil JPN Melaka</title>
	
	<link rel="icon" type="image/png" href="https://i.postimg.cc/jdp3yqpZ/logotech.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Guna fon Oswald sebagai default */
        body {
            font-family: 'Oswald', sans-serif;
        }

        /* --- STYLES BARU DARI PROTOTYPE BERMULA DI SINI --- */
        
        /* [cite: 6, 7] */
        .modal {
            display: none; 
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        /* [cite: 8] */
        .modal-content {
            background-color: white;
            margin: 30px auto;
            padding: 0;
            border: none;
            width: 820px; /* Lebar dari prototaip */
            position: relative;
            box-shadow: 0 6px 18px #0005;
        }

        /* [cite: 9, 10] */
        .print-btn-container {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.95);
            text-align: center;
            padding: 10px;
            z-index: 10;
            border-bottom: 1px solid #ccc;
        }
        
        /* [cite: 19] */
        .close {
            position: absolute;
            top: 10px;
            right: 18px;
            font-size: 28px;
            cursor: pointer;
            color: #555;
        }

        /* [cite: 11] */
        .sijil-a4 {
            width: 794px; /* Logik Pixel */
            height: 1123px; /* Logik Pixel */
            padding: 10px;
            /* Guna imej latar dari prototaip */
            background: url('https://i.imgur.com/Us4sEN6.png') no-repeat center center;
            background-size: cover;
            position: relative;
            box-sizing: border-box;
            margin: 0 auto;
        }

        /* [cite: 12, 13] */
        .centered-content {
            position: absolute;
            top: 290px; /* Kedudukan dari prototaip */
            left: 0;
            right: 0;
            padding: 0 60px;
            text-align: center;
            color: #000;
        }

        /* Gaya teks sijil dari prototaip [cite: 14, 15, 18] */
        .centered-content .nama {
            font-size: 28px;
            font-weight: bold;
            margin-top: 14px;
        }
        .centered-content .kp {
            margin: 10px 0;
            font-size: 16px;
        }
        .centered-content .nota {
            margin-top: 30px;
            font-size: 11px;
            font-style: italic;
            color: #777;
        }

        /* --- LOGIK CETAK DARI PROTOTYPE BERMULA DI SINI --- */
        
        @media print {
            
            /* [cite: 20] */
            html, body {
                margin: 0;
                padding: 0;
                height: 100%;
                overflow: hidden;
                background: white;
            }

            /* [cite: 21] */
            .modal, .modal-content {
                all: unset;
                display: block;
                width: 100%;
                height: 100%;
            }

            /* [cite: 22, 23] */
            .sijil-a4 {
                width: 794px;
                height: 1123px;
                padding: 10px;
                background-size: cover;
                background-repeat: no-repeat;
                background-position: center;
                margin: auto;
                page-break-before: avoid;
                page-break-after: avoid;
                break-after: avoid-page;
                break-before: avoid-page;
                overflow: hidden;
                /* WAJIB: Paksa imej latar dicetak */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* [cite: 24] - Sembunyikan semua elemen UI */
            header, nav, #tab-content-1, #tab-content-3, footer, 
            #form-semakan, .print-btn-container, .close {
                display: none !important;
            }
        }
        /* --- LOGIK CETAK TAMAT --- */
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
        
        <header>
            <img 
                src="https://i.postimg.cc/prtyDFJQ/tech2025.png" 
                alt="Header Sistem e-Sijil" 
                class="w-full h-auto"
            >
        </header>

        <nav class="flex border-b">
            <button id="tab-btn-1" class="tab-button flex-1 py-4 px-6 text-center font-medium text-gray-700 hover:bg-gray-100 focus:outline-none transition duration-150 ease-in-out">
                Daftar Kehadiran
            </button>
            <button id="tab-btn-2" class="tab-button flex-1 py-4 px-6 text-center font-medium text-gray-700 hover:bg-gray-100 focus:outline-none transition duration-150 ease-in-out">
                Semak Sijil
            </button>
            <button id="tab-btn-3" class="tab-button flex-1 py-4 px-6 text-center font-medium text-gray-700 hover:bg-gray-100 focus:outline-none transition duration-150 ease-in-out">
                Rumusan
            </button>
        </nav>

        <div class="p-6 md:p-8">
            <div id="tab-content-1" class="tab-content">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Borang Pendaftaran Peserta</h2>
                <form id="form-pendaftaran" class="space-y-6">
                    <div>
                        <label for="nama" class="block text-sm font-medium text-gray-700 mb-1">Nama Penuh (HURUF BESAR)</label>
                        <input type="text" id="nama" name="nama" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required
                               oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div>
                        <label for="nokp" class="block text-sm font-medium text-gray-700 mb-1">No. Kad Pengenalan (12 digit, tanpa '-')</label>
                        <input type="text" id="nokp" name="nokp" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required
                               pattern="[0-9]{12}" maxlength="12" title="Sila masukkan 12 digit nombor KP tanpa sempang.">
                    </div>
                    <div>
                        <label for="negeri" class="block text-sm font-medium text-gray-700 mb-1">Negeri</label>
                        <select id="negeri" name="negeri" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white" required>
                            <option value="">-- Sila Pilih Negeri --</option>
                            <option value="PAHANG">PAHANG</option>
                            <option value="PERAK">PERAK</option>
                            <option value="TERENGGANU">TERENGGANU</option>
                            <option value="PERLIS">PERLIS</option>
                            <option value="SELANGOR">SELANGOR</option>
                            <option value="NEGERI SEMBILAN">NEGERI SEMBILAN</option>
                            <option value="JOHOR">JOHOR</option>
                            <option value="KELANTAN">KELANTAN</option>
                            <option value="KEDAH">KEDAH</option>
                            <option value="PULAU PINANG">PULAU PINANG</option>
                            <option value="MELAKA">MELAKA</option>
                            <option value="SABAH">SABAH</option>
                            <option value="SARAWAK">SARAWAK</option>
                            <option value="WILAYAH PERSEKUTUAN KUALA LUMPUR">WILAYAH PERSEKUTUAN KUALA LUMPUR</option>
                            <option value="WILAYAH PERSEKUTUAN LABUAN">WILAYAH PERSEKUTUAN LABUAN</option>
                            <option value="WILAYAH PERSEKUTUAN PUTRAJAYA">WILAYAH PERSEKUTUAN PUTRAJAYA</option>
                        </select>
                    </div>
                    <div id="daerah-melaka-container" class="hidden space-y-1">
                        <label for="daerah" class="block text-sm font-medium text-gray-700">Daerah (Melaka)</label>
                        <select id="daerah" name="daerah" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <option value="">-- Sila Pilih Daerah --</option>
                            <option value="ALOR GAJAH">ALOR GAJAH</option>
                            <option value="JASIN">JASIN</option>
                            <option value="MELAKA TENGAH">MELAKA TENGAH</option>
                        </select>
                    </div>
                    <div>
                        <label for="peranan" class="block text-sm font-medium text-gray-700 mb-1">Peranan</label>
                        <select id="peranan" name="peranan" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white" required>
                            <option value="">-- Sila Pilih Peranan --</option>
                            <option value="MURID / PELAJAR">MURID / PELAJAR</option>
                            <option value="GURU">GURU</option>
                            <option value="PEGAWAI DI JPN">PEGAWAI DI JPN</option>
                            <option value="PEGAWAI DI PPD">PEGAWAI DI PPD</option>
                            <option value="IBU BAPA">IBU BAPA</option>
                        </select>
                    </div>
                    <div>
                        <label for="sekolah" class="block text-sm font-medium text-gray-700 mb-1">Nama Sekolah / Jabatan (HURUF BESAR)</label>
                        <input type="text" id="sekolah" name="sekolah" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                               oninput="this.value = this.value.toUpperCase()">
                        <p id="sekolah-helper" class="text-xs text-gray-500 mt-1">Wajib diisi jika peranan anda GURU, MURID, PEGAWAI JPN, atau PEGAWAI PPD.</p>
                    </div>
                    <div>
                        <button type="submit" id="submit-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-blue-700 hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            Hantar Pendaftaran
                        </button>
                    </div>
                </form>
            </div>

            <div id="tab-content-2" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Semakan Sijil</h2>
                <form id="form-semakan" class="flex flex-col sm:flex-row gap-4 mb-6">
                    <div class="flex-grow">
                        <label for="nokp-semak" class="block text-sm font-medium text-gray-700 mb-1">No. Kad Pengenalan</label>
                        <input type="text" id="nokp-semak" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Masukkan 12 digit No. KP" pattern="[0-9]{12}" maxlength="12" required>
                    </div>
                    <div class="flex items-end gap-2">
                        <button type="submit" id="search-btn" class="w-full sm:w-auto flex justify-center py-2 px-6 border border-transparent rounded-md shadow-sm text-lg font-medium text-black bg-yellow-500 hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-400 transition duration-150 ease-in-out">
                            Cari
                        </button>
                        <button type="button" id="reset-btn" class="w-full sm:w-auto flex justify-center py-2 px-6 border border-gray-300 rounded-md shadow-sm text-lg font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            Reset
                        </button>
                    </div>
                </form>
                
                <div id="sijil-container" class="mt-6">
                    <div id="sijilModal" class="modal">
                        <div class="modal-content">
                            <div class="print-btn-container">
                                <button 
                                    onclick="printSijil()" 
                                    class="py-2 px-6 bg-green-600 text-white font-bold rounded-md shadow-md hover:bg-green-700 transition duration-150">
                                    Cetak Sijil
                                </button>
                            </div>
                            <span class="close" onclick="tutupModal()">&times;</span>
                            
                            <div class="sijil-a4" id="sijilContent">
                                <div class="centered-content" id="sijilInnerContent">
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

            <div id="tab-content-3" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Rumusan Kehadiran</h2>
                
                <div id="rumusan-global-container" class="mb-8 p-6 bg-gray-50 rounded-lg shadow-inner">
                    <h3 class="text-xl font-bold mb-4">Rumusan Keseluruhan</h3>
                    </div>
                
                <h3 class="text-xl font-bold mb-4">Pecahan Mengikut Negeri</h3>
                <div id="rumusan-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    </div>
            </div>
        </div>
    </div>

    <footer class="text-center text-gray-500 text-sm mt-8">
        Hakcipta Terpelihara #TEAMjpnmelaka
    </footer>

    <script type="module">
        // --- 3. KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://qixtrxechyvxjdxthfrb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpeHRyeGVjaHl2eGpkeHRoZnJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3Njg1NDcsImV4cCI6MjA3NzM0NDU0N30.emTaRn3JyI5hivpKxUL9kqmiV1TAJmH3oAohgBT-2eI';
        
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- (DIHAPUSKAN) KONFIGURASI SIJIL (Tidak lagi diguna) ---
        // const POSISI_NAMA = '30%'; 

        // --- ELEMEN DOM ---
        const tabButtons = {
            btn1: document.getElementById('tab-btn-1'),
            btn2: document.getElementById('tab-btn-2'),
            btn3: document.getElementById('tab-btn-3'),
        };
        const tabContents = {
            content1: document.getElementById('tab-content-1'),
            content2: document.getElementById('tab-content-2'),
            content3: document.getElementById('tab-content-3'),
        };
        
        // Borang Pendaftaran (Tab 1)
        const formPendaftaran = document.getElementById('form-pendaftaran');
        const negeriSelect = document.getElementById('negeri');
        const daerahContainer = document.getElementById('daerah-melaka-container');
        const daerahSelect = document.getElementById('daerah');
        const perananSelect = document.getElementById('peranan');
        const sekolahInput = document.getElementById('sekolah');
        const submitBtn = document.getElementById('submit-btn');

        // Borang Semakan (Tab 2)
        const formSemakan = document.getElementById('form-semakan');
        const nokpSemakInput = document.getElementById('nokp-semak');
        // 'sijilContainer' kini memegang modal
        const sijilContainer = document.getElementById('sijil-container'); 
        const searchBtn = document.getElementById('search-btn');
        const resetBtn = document.getElementById('reset-btn');
        // Elemen BARU dari prototaip
        const sijilModal = document.getElementById('sijilModal');
        const sijilInnerContent = document.getElementById('sijilInnerContent');
        
        // Rumusan (Tab 3)
        const rumusanGlobalContainer = document.getElementById('rumusan-global-container');
        const rumusanContainer = document.getElementById('rumusan-container');
        const perananWajibSekolah = ['MURID / PELAJAR', 'GURU', 'PEGAWAI DI JPN', 'PEGAWAI DI PPD'];
        const senaraiNegeri = [
            'JOHOR', 'KEDAH', 'KELANTAN', 'MELAKA', 'NEGERI SEMBILAN', 'PAHANG', 'PERAK', 
            'PERLIS', 'PULAU PINANG', 'SABAH', 'SARAWAK', 'SELANGOR', 'TERENGGANU', 
            'WILAYAH PERSEKUTUAN KUALA LUMPUR', 'WILAYAH PERSEKUTUAN LABUAN', 'WILAYAH PERSEKUTUAN PUTRAJAYA'
        ];
        const senaraiPeranan = ['MURID / PELAJAR', 'GURU', 'PEGAWAI DI JPN', 'PEGAWAI DI PPD', 'IBU BAPA'];
        const namaPaparanPeranan = {
            'MURID / PELAJAR': 'MURID',
            'GURU': 'GURU',
            'PEGAWAI DI JPN': 'JPN',
            'PEGAWAI DI PPD': 'PPD',
            'IBU BAPA': 'IBU BAPA'
        };


        // --- FUNGSI UTAMA ---

        function showTab(tabId) {
            Object.values(tabContents).forEach(content => content.classList.add('hidden'));
            Object.values(tabButtons).forEach(btn => btn.classList.remove('bg-red-600', 'text-white')); 
            
            tabContents[`content${tabId}`].classList.remove('hidden');
            tabButtons[`btn${tabId}`].classList.add('bg-red-600', 'text-white');

            if (tabId === '3') {
                loadRumusan();
            }
        }

        // --- LOGIK TAB 1: PENDAFTARAN (Tiada Perubahan) ---

        negeriSelect.addEventListener('change', () => {
            if (negeriSelect.value === 'MELAKA') {
                daerahContainer.classList.remove('hidden');
                daerahSelect.required = true;
            } else {
                daerahContainer.classList.add('hidden');
                daerahSelect.required = false;
                daerahSelect.value = '';
            }
        });

        perananSelect.addEventListener('change', () => {
            if (perananWajibSekolah.includes(perananSelect.value)) {
                sekolahInput.required = true;
                document.getElementById('sekolah-helper').classList.add('text-red-500', 'font-medium');
            } else {
                sekolahInput.required = false;
                document.getElementById('sekolah-helper').classList.remove('text-red-500', 'font-medium');
            }
        });

        formPendaftaran.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;
            submitBtn.textContent = 'Menghantar...';

            const formData = new FormData(formPendaftaran);
            const dataObj = {
                nama: formData.get('nama'),
                nokp: formData.get('nokp'),
                negeri: formData.get('negeri'),
                daerah: formData.get('negeri') === 'MELAKA' ? formData.get('daerah') : null,
                peranan: formData.get('peranan'),
                sekolah: formData.get('sekolah') || null,
            };

            if (perananWajibSekolah.includes(dataObj.peranan) && !dataObj.sekolah) {
                Swal.fire({
                    icon: 'error',
                    title: 'Borang Tidak Lengkap',
                    text: 'Nama Sekolah / Jabatan wajib diisi untuk peranan anda.',
                });
                submitBtn.disabled = false;
                submitBtn.textContent = 'Hantar Pendaftaran';
                return;
            }

            try {
                const { data, error } = await db
                    .from('peserta')
                    .upsert(dataObj, { onConflict: 'nokp' }) 
                    .select();
                
                if (error) { throw error; }

                Swal.fire({
                    icon: 'success',
                    title: 'Pendaftaran Berjaya!',
                    text: 'Maklumat anda telah disimpan/dikemas kini. Sila ke Tab "Semak Sijil".',
                    timer: 2000,
                    showConfirmButton: false
                });
                formPendaftaran.reset();
                daerahContainer.classList.add('hidden');
            
            } catch (error) {
                console.error('Ralat Pendaftaran:', error.message);
                Swal.fire({
                    icon: 'error',
                    title: 'Pendaftaran Gagal',
                    text: error.message,
                });
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Hantar Pendaftaran';
            }
        });


        // --- LOGIK TAB 2: SEMAKAN SIJIL (DIUBAHSUAI) ---

        formSemakan.addEventListener('submit', async (e) => {
            e.preventDefault();
            sijilInnerContent.innerHTML = ''; // Kosongkan kandungan modal
            searchBtn.disabled = true;
            searchBtn.textContent = 'Mencari...';

            const nokp = nokpSemakInput.value;

            try {
                const { data, error } = await db
                    .from('peserta')
                    .select('*')
                    .eq('nokp', nokp)
                    .single();

                if (error || !data) {
                    throw new Error('Data tidak ditemui. Sila pastikan No. KP anda betul atau daftar di Tab 1.');
                }

                generateCertificate(data); // Fungsi ini kini memaparkan modal
                
                Swal.fire({
                    icon: 'success',
                    title: 'Sijil Ditemui',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });

            } catch (error) {
                console.error('Ralat Semakan:', error.message);
                Swal.fire({
                    icon: 'error',
                    title: 'Semakan Gagal',
                    text: error.message,
                });
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Cari';
            }
        });

        // Event listener untuk butang Reset (DIUBAHSUAI)
        resetBtn.addEventListener('click', () => {
            nokpSemakInput.value = '';
            sijilInnerContent.innerHTML = ''; // Kosongkan modal
            tutupModal(); // Tutup modal jika terbuka
        });

        // --- FUNGSI JANA SIJIL (DIUBAHSUAI GUNA LOGIK PROTOTYPE) ---
        function generateCertificate(peserta) {
            // Jana HTML menggunakan gaya dari prototaip [cite: 14, 15, 18]
            // Data 'program' dan 'tarikh' tiada dalam DB, jadi kita hanya guna nama & kp
            const sijilHtml = `
                <div class="nama">
                    ${peserta.nama}
                </div>
                <div class="kp">
                    No. KP: ${peserta.nokp}
                </div>
                <div class="nota" style="margin-top: 50px;">
                    (Sijil ini dijana secara automatik oleh sistem e-Sijil JPN Melaka)
                </div>
            `;
            
            sijilInnerContent.innerHTML = sijilHtml;
            sijilModal.style.display = 'block'; // Paparkan modal
        }

        // --- FUNGSI BARU DARI PROTOTYPE ---
        
        // [cite: 30, 31]
        function tutupModal() {
            sijilModal.style.display = "none";
        }

        // [cite: 32]
        function printSijil() {
            window.print();
        }
        
        // Pasang fungsi ke 'window' supaya 'onclick' HTML boleh mencapainya
        window.tutupModal = tutupModal;
        window.printSijil = printSijil;

        // [cite: 33, 34]
        window.onclick = function(event) {
            if (event.target === sijilModal) {
                tutupModal();
            }
        };


        // --- LOGIK TAB 3: RUMUSAN (Tiada Perubahan) ---
        
        async function loadRumusan() {
            const loadingHtml = '<p class="text-gray-500">Memuatkan data rumusan...</p>';
            rumusanContainer.innerHTML = loadingHtml;
            rumusanGlobalContainer.innerHTML = loadingHtml;
            
            try {
                const { data, error } = await db
                    .from('peserta')
                    .select('negeri, peranan, nokp'); 

                if (error) throw error; 

                // 1. Sediakan templat rumusan (per-negeri)
                const summaryNegeri = {};
                senaraiNegeri.forEach(negeri => {
                    summaryNegeri[negeri] = { TOTAL: 0 };
                    senaraiPeranan.forEach(peranan => {
                        summaryNegeri[negeri][peranan] = 0;
                    });
                });
                
                let summaryGlobal = {
                    TOTAL: 0,
                    LELAKI: 0,
                    PEREMPUAN: 0,
                    ...Object.fromEntries(senaraiPeranan.map(p => [p, 0])) 
                };

                // 2. Kira data
                data.forEach(item => {
                    if (summaryNegeri[item.negeri] && summaryNegeri[item.negeri][item.peranan] !== undefined) {
                        summaryNegeri[item.negeri][item.peranan]++;
                        summaryNegeri[item.negeri]['TOTAL']++;
                    }
                    summaryGlobal.TOTAL++;
                    if (summaryGlobal[item.peranan] !== undefined) {
                        summaryGlobal[item.peranan]++;
                    }
                    if (item.nokp && item.nokp.length === 12) {
                        const lastDigit = parseInt(item.nokp.slice(-1));
                        if (lastDigit % 2 === 0) {
                            summaryGlobal.PEREMPUAN++;
                        } else {
                            summaryGlobal.LELAKI++;
                        }
                    }
                });
                
                const negeriUnik = new Set(data.map(item => item.negeri));

                // 3. Jana HTML untuk Rumusan Global
                let globalHtml = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm font-medium text-gray-500">JUMLAH BESAR</div>
                            <div class="text-3xl font-bold text-red-600">${summaryGlobal.TOTAL}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm font-medium text-gray-500">LELAKI</div>
                            <div class="text-3xl font-bold text-blue-600">${summaryGlobal.LELAKI}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm font-medium text-gray-500">PEREMPUAN</div>
                            <div class="text-3xl font-bold text-pink-500">${summaryGlobal.PEREMPUAN}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm font-medium text-gray-500">NEGERI</div>
                            <div class="text-3xl font-bold text-green-600">${negeriUnik.size}</div>
                        </div>
                    </div>
                    <hr class="my-6 border-gray-200">
                    <h4 class="text-lg font-semibold mb-3">Pecahan Mengikut Peranan</h4>
                    <ul class="space-y-2 text-gray-700">
                        ${senaraiPeranan.map(peranan => `
                            <li class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                                <span class="font-medium">${peranan}</span>
                                <span class="font-bold text-lg text-red-600">${summaryGlobal[peranan]}</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
                rumusanGlobalContainer.innerHTML = globalHtml;

                // 4. Jana HTML untuk Pecahan Negeri (Heatmap)
                let heatmapHtml = '';
                const maxTotal = Math.max(...Object.values(summaryNegeri).map(n => n.TOTAL));
                
                senaraiNegeri.forEach(negeri => {
                    const negeriData = summaryNegeri[negeri];
                    const total = negeriData.TOTAL;
                    
                    let bgOpacity = 20; 
                    if (maxTotal > 0 && total > 0) {
                        bgOpacity = 20 + Math.floor((total / maxTotal) * 80);
                    }
                    
                    heatmapHtml += `
                        <div class="border border-gray-200 rounded-lg shadow-md overflow-hidden bg-blue-600 flex flex-col" style="background-color: rgba(37, 99, 235, ${bgOpacity / 100});">
                            <div class="p-4 ${bgOpacity > 50 ? 'text-white' : 'text-gray-900'}">
                                <h4 class="text-lg font-bold">${negeri}</h4>
                                <p class="text-3xl font-extrabold">${total}</p>
                            </div>
                            <div class="bg-gray-50 p-4 border-t ${bgOpacity > 50 ? 'text-gray-700' : ''}">
                                <ul class="text-sm space-y-1">
                                    ${senaraiPeranan.map(peranan => `
                                        <li class="flex justify-between">
                                            <span>${namaPaparanPeranan[peranan] || peranan}</span>
                                            <span class="font-medium">${negeriData[peranan]}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                });
                rumusanContainer.innerHTML = heatmapHtml;

            } catch (error) {
                console.error('Ralat Memuatkan Rumusan:', error.message);
                const errorHtml = `<p class="text-red-500 font-bold">Gagal memuatkan data: ${error.message}</p>`;
                rumusanContainer.innerHTML = errorHtml;
                rumusanGlobalContainer.innerHTML = errorHtml;

                Swal.fire({
                    icon: 'error',
                    title: 'Gagal Muat Rumusan',
                    text: error.message,
                });
            }
        }


        // --- PENYEDIAAN AWAL ---
        
        tabButtons.btn1.addEventListener('click', () => showTab('1'));
        tabButtons.btn2.addEventListener('click', () => showTab('2'));
        tabButtons.btn3.addEventListener('click', () => showTab('3'));

        showTab('1');
    </script>
</body>
</html>