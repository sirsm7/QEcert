<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QEcert â€“ Sistem eSijil Techlym</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Oswald Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        /* Guna fon Oswald sebagai default */
        body {
            font-family: 'Oswald', sans-serif;
        }

        /* Paparan Sijil (Mesra Mudah Alih) */
        #sijil-wrapper {
            width: 100%;
            max-width: 210mm;
            aspect-ratio: 210 / 297;
            height: auto;
            position: relative;
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
            margin: 20px auto;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            background-image: url('./sijil_techlym.png?v=1');
        }

        .sijil-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-family: 'Times New Roman', Times, serif;
            color: #000;
        }

        /* --- PERUBAHAN CSS CETAK TAMAT DI SINI --- */

        /* Modal paparan sijil ala sistem prototaip */
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            inset: 0;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: white;
            margin: 30px auto;
            padding: 0;
            border-radius: 8px;
            max-width: 900px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            position: relative;
        }

        .print-btn-container {
            position: sticky;
            top: 0;
            background: rgba(255,255,255,0.95);
            text-align: center;
            padding: 10px;
            z-index: 10;
            border-bottom: 1px solid #ccc;
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            margin: 0 4px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background-color: #16a34a;
            color: #fff;
        }

        .btn-secondary {
            background-color: #e5e7eb;
            color: #111827;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 16px;
            font-size: 28px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
        }

        .sijil-a4 {
            padding: 10px;
            background: #f3f4f6;
            display: flex;
            justify-content: center;
        }

        /* Paparan sijil sebenar kekal guna #sijil-wrapper */
        @media print {
            html, body {
                margin: 0;
                padding: 0;
                height: 100%;
                overflow: hidden;
                background: white;
            }

            /* Sembunyikan elemen lain asas */
            header, footer, nav, #tab-content-1, #tab-content-3, #form-semakan {
                display: none !important;
            }

            .modal {
                display: block;
                position: static;
                background: transparent;
                margin: 0;
                padding: 0;
            }

            .modal-content {
                margin: 0;
                padding: 0;
                box-shadow: none;
                border-radius: 0;
                border: none;
                width: 100%;
                max-width: none;
            }

            .sijil-a4 {
                background: white;
                padding: 0;
                justify-content: center;
            }

            #sijil-wrapper {
                width: 210mm;
                height: 297mm;
                max-width: none;
                margin: 0 auto;
                box-shadow: none;
                background-size: 100% 100% !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .print-btn-container,
            .close,
            .btn {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-white shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-600 text-white flex items-center justify-center rounded-full text-xl font-bold">
                    Q
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-800 tracking-wide">
                        QEcert Techlym
                    </h1>
                    <p class="text-sm text-gray-500">
                        Sistem eSijil Program Literasi Teknologi dan Matematik
                    </p>
                </div>
            </div>
            <div class="hidden sm:block text-xs text-gray-500 text-right">
                Dibangunkan dengan Supabase dan Tailwind
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                    <button id="tab-btn-1" class="tab-btn px-4 py-2 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-blue-600 hover:border-blue-300">
                        Daftar Peserta
                    </button>
                    <button id="tab-btn-2" class="tab-btn px-4 py-2 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-blue-600 hover:border-blue-300">
                        Semakan Sijil
                    </button>
                    <button id="tab-btn-3" class="tab-btn px-4 py-2 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-blue-600 hover:border-blue-300">
                        Rumusan Kehadiran
                    </button>
                </nav>
            </div>

            <div id="tab-content-1" class="tab-content">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Daftar Peserta</h2>
                <form id="form-pendaftaran" class="space-y-4">
                    <div>
                        <label for="nama" class="block text-sm font-medium text-gray-700 mb-1">Nama Penuh (HURUF BESAR)</label>
                        <input type="text" id="nama" name="nama" required
                               class="block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500"
                               oninput="this.value = this.value.toUpperCase()">
                    </div>

                    <div>
                        <label for="nokp" class="block text-sm font-medium text-gray-700 mb-1">No Kad Pengenalan (tanpa sengkang)</label>
                        <input type="text" id="nokp" name="nokp" required
                               pattern="[0-9]{12}" maxlength="12"
                               class="block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Contoh 030215050123">
                        <p class="text-xs text-gray-500 mt-1">Sila pastikan 12 digit dan betul</p>
                    </div>

                    <div>
                        <label for="negeri" class="block text-sm font-medium text-gray-700 mb-1">Negeri</label>
                        <select id="negeri" name="negeri" required
                                class="block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Sila pilih negeri</option>
                            <option value="JOHOR">JOHOR</option>
                            <option value="KEDAH">KEDAH</option>
                            <option value="KELANTAN">KELANTAN</option>
                            <option value="MELAKA">MELAKA</option>
                            <option value="NEGERI SEMBILAN">NEGERI SEMBILAN</option>
                            <option value="PAHANG">PAHANG</option>
                            <option value="PERAK">PERAK</option>
                            <option value="PERLIS">PERLIS</option>
                            <option value="PULAU PINANG">PULAU PINANG</option>
                            <option value="SABAH">SABAH</option>
                            <option value="SARAWAK">SARAWAK</option>
                            <option value="SELANGOR">SELANGOR</option>
                            <option value="TERENGGANU">TERENGGANU</option>
                            <option value="WILAYAH PERSEKUTUAN KUALA LUMPUR">WILAYAH PERSEKUTUAN KUALA LUMPUR</option>
                            <option value="WILAYAH PERSEKUTUAN LABUAN">WILAYAH PERSEKUTUAN LABUAN</option>
                            <option value="WILAYAH PERSEKUTUAN PUTRAJAYA">WILAYAH PERSEKUTUAN PUTRAJAYA</option>
                        </select>
                    </div>

                    <div id="daerah-melaka-container" class="hidden">
                        <label for="daerah" class="block text-sm font-medium text-gray-700 mb-1">Daerah (MELAKA)</label>
                        <select id="daerah" name="daerah"
                                class="block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Sila pilih daerah</option>
                            <option value="ALOR GAJAH">ALOR GAJAH</option>
                            <option value="MELAKA TENGAH">MELAKA TENGAH</option>
                            <option value="JASIN">JASIN</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">
                            Medan ini hanya wajib untuk peserta dari negeri Melaka
                        </p>
                    </div>

                    <div>
                        <label for="peranan" class="block text-sm font-medium text-gray-700 mb-1">Peranan</label>
                        <select id="peranan" name="peranan" required
                                class="block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Sila pilih peranan</option>
                            <option value="MURID / PELAJAR">MURID / PELAJAR</option>
                            <option value="GURU">GURU</option>
                            <option value="PEGAWAI DI JPN">PEGAWAI DI JPN</option>
                            <option value="PEGAWAI DI PPD">PEGAWAI DI PPD</option>
                            <option value="IBU BAPA">IBU BAPA</option>
                        </select>
                    </div>

                    <div>
                        <label for="sekolah" class="block text-sm font-medium text-gray-700 mb-1">Nama Sekolah / Agensi / Jabatan (HURUF BESAR)</label>
                        <input type="text" id="sekolah" name="sekolah" required
                               class="block w-full rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                               oninput="this.value = this.value.toUpperCase()">
                        <p id="sekolah-helper" class="text-xs text-gray-500 mt-1">
                            Contoh: SK HUTAN PERCHA, SMK RAHMAT, PPD ALOR GAJAH
                        </p>
                    </div>

                    <div>
                        <button type="submit" id="submit-btn"
                                class="inline-flex items-center justify-center px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            Hantar Pendaftaran
                        </button>
                    </div>
                </form>
            </div>

            <div id="tab-content-2" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Semakan Sijil</h2>
                <form id="form-semakan" class="flex flex-col sm:flex-row gap-4 mb-6">
                    <div class="flex-grow">
                        <label for="nokp-semak" class="block text-sm font-medium text-gray-700 mb-1">No. Kad Pengenalan</label>
                        <input type="text" id="nokp-semak"
                               class="block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Masukkan 12 digit No. KP" pattern="[0-9]{12}" maxlength="12" required>
                    </div>
                    <div class="flex items-end gap-2">
                        <button type="submit" id="search-btn"
                                class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-yellow-500 hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-400 transition duration-150 ease-in-out">
                            Cari
                        </button>
                        <button type="button" id="reset-btn"
                                class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            Reset
                        </button>
                    </div>
                </form>
                
                <div id="sijil-container" class="mt-6">
                </div>
            </div>

            <div id="tab-content-3" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Rumusan Kehadiran</h2>
                
                <div id="rumusan-global-container" class="mb-8 p-6 bg-gray-50 rounded-lg shadow-inner">
                    <h3 class="text-xl font-bold mb-4">Rumusan Keseluruhan</h3>
                </div>
                
                <h3 class="text-xl font-bold mb-4">Pecahan Mengikut Negeri</h3>
                <div id="rumusan-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Paparan Sijil ala Sistem Prototaip -->
    <div id="sijilModal" class="modal">
        <div class="modal-content">
            <div class="print-btn-container">
                <button id="modal-print-btn" class="btn btn-primary">Cetak / Simpan PDF</button>
                <button id="modal-close-btn" class="btn btn-secondary">Tutup</button>
            </div>
            <span id="modal-close-icon" class="close">&times;</span>
            <div class="sijil-a4">
                <div id="sijilContent">
                    <!-- Kandungan sijil akan dimasukkan melalui JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center text-gray-500 text-sm mt-8">
        Hakcipta Terpelihara TEAMjpnmelaka
    </footer>

    <script type="module">
        // --- 3. KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://qixtrxechyvxjdxthfrb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVC...CI6MjA3NzM0NDU0N30.emTaRn3JyI5hivpKxUL9kqmiV1TAJmH3oAohgBT-2eI';
        
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- KONFIGURASI SIJIL (DIKEMASKINI) ---
        const POSISI_NAMA = '30%';

        // --- ELEMEN DOM ---
        const tabButtons = {
            btn1: document.getElementById('tab-btn-1'),
            btn2: document.getElementById('tab-btn-2'),
            btn3: document.getElementById('tab-btn-3'),
        };
        const tabContents = {
            content1: document.getElementById('tab-content-1'),
            content2: document.getElementById('tab-content-2'),
            content3: document.getElementById('tab-content-3'),
        };
        
        // Borang Pendaftaran (Tab 1)
        const formPendaftaran = document.getElementById('form-pendaftaran');
        const negeriSelect = document.getElementById('negeri');
        const daerahContainer = document.getElementById('daerah-melaka-container');
        const daerahSelect = document.getElementById('daerah');
        const perananSelect = document.getElementById('peranan');
        const sekolahInput = document.getElementById('sekolah');
        const submitBtn = document.getElementById('submit-btn');

        // Borang Semakan (Tab 2)
        const formSemakan = document.getElementById('form-semakan');
        const nokpSemakInput = document.getElementById('nokp-semak');
        const sijilContainer = document.getElementById('sijil-container');
        const searchBtn = document.getElementById('search-btn');
        const resetBtn = document.getElementById('reset-btn');

        // Modal paparan sijil ala prototaip
        const sijilModal = document.getElementById('sijilModal');
        const sijilContent = document.getElementById('sijilContent');
        const modalPrintBtn = document.getElementById('modal-print-btn');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalCloseIcon = document.getElementById('modal-close-icon');
        
        // Rumusan (Tab 3)
        const rumusanGlobalContainer = document.getElementById('rumusan-global-container');
        const rumusanContainer = document.getElementById('rumusan-container');
        const perananWajibSekolah = ['MURID / PELAJAR', 'GURU', 'PEGAWAI DI JPN', 'PEGAWAI DI PPD'];
        const senaraiNegeri = [
            'JOHOR', 'KEDAH', 'KELANTAN', 'MELAKA',
            'NEGERI SEMBILAN', 'PAHANG', 'PERAK', 
            'PERLIS', 'PULAU PINANG', 'SABAH', 'SARAWAK', 'SELANGOR', 'TERENGGANU', 
            'WILAYAH PERSEKUTUAN KUALA LUMPUR', 'WILAYAH PERSEKUTUAN LABUAN', 'WILAYAH PERSEKUTUAN PUTRAJAYA'
        ];
        const senaraiPeranan = ['MURID / PELAJAR', 'GURU', 'PEGAWAI DI JPN', 'PEGAWAI DI PPD', 'IBU BAPA'];

        const namaPaparanPeranan = {
            'MURID / PELAJAR': 'MURID',
            'GURU': 'GURU',
            'PEGAWAI DI JPN': 'JPN',
            'PEGAWAI DI PPD': 'PPD',
            'IBU BAPA': 'IBU BAPA'
        };

        // Fungsi tukar tab
        function showTab(tabId) {
            Object.values(tabContents).forEach(content => content.classList.add('hidden'));
            Object.values(tabButtons).forEach(btn => btn.classList.remove('bg-red-600', 'text-white')); 
            
            tabContents[`content${tabId}`].classList.remove('hidden');
            tabButtons[`btn${tabId}`].classList.add('bg-red-600', 'text-white');

            if (tabId === '3') {
                loadRumusan();
            }
        }

        // --- FUNGSI BANTU MODAL SIJIL ---
        if (modalPrintBtn) {
            modalPrintBtn.addEventListener('click', () => {
                window.print();
            });
        }

        [modalCloseBtn, modalCloseIcon].forEach(btn => {
            if (btn) {
                btn.addEventListener('click', () => {
                    if (sijilModal) {
                        sijilModal.style.display = 'none';
                    }
                });
            }
        });

        window.addEventListener('click', (event) => {
            if (event.target === sijilModal) {
                sijilModal.style.display = 'none';
            }
        });

        // --- LOGIK TAB 1: PENDAFTARAN ---
        tabButtons.btn1.addEventListener('click', () => showTab('1'));
        tabButtons.btn2.addEventListener('click', () => showTab('2'));
        tabButtons.btn3.addEventListener('click', () => showTab('3'));

        negeriSelect.addEventListener('change', () => {
            if (negeriSelect.value === 'MELAKA') {
                daerahContainer.classList.remove('hidden');
            } else {
                daerahContainer.classList.add('hidden');
                daerahSelect.value = '';
            }
        });

        formPendaftaran.addEventListener('submit', async (e) => {
            e.preventDefault();

            const nama = nama.value.trim();
            const nokp = document.getElementById('nokp').value.trim();
            const negeri = negeriSelect.value;
            const daerah = daerahSelect.value || null;
            const peranan = perananSelect.value;
            const sekolah = sekolahInput.value.trim();

            if (!nama || !nokp || !negeri || !peranan || !sekolah) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Medan wajib belum lengkap',
                    text: 'Sila pastikan semua medan wajib diisi.'
                });
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Menyimpan...';

            try {
                const { error } = await db
                    .from('peserta')
                    .upsert({
                        nama,
                        nokp,
                        negeri,
                        daerah,
                        peranan,
                        sekolah
                    }, { onConflict: 'nokp' });

                if (error) throw error;

                Swal.fire({
                    icon: 'success',
                    title: 'Berjaya',
                    text: 'Pendaftaran anda telah disimpan / dikemas kini.'
                });

                formPendaftaran.reset();
                daerahContainer.classList.add('hidden');
            } catch (error) {
                console.error('Ralat pendaftaran:', error.message);
                Swal.fire({
                    icon: 'error',
                    title: 'Ralat',
                    text: 'Pendaftaran gagal. Sila cuba semula.'
                });
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Hantar Pendaftaran';
            }
        });

        // --- LOGIK TAB 2: SEMAKAN SIJIL ---
        formSemakan.addEventListener('submit', async (e) => {
            e.preventDefault();
            sijilContainer.innerHTML = '';
            searchBtn.disabled = true;
            searchBtn.textContent = 'Mencari...';

            const nokp = nokpSemakInput.value;

            try {
                const { data, error } = await db
                    .from('peserta')
                    .select('*')
                    .eq('nokp', nokp)
                    .single();

                if (error || !data) {
                    throw new Error('Data tidak ditemui. Sila pastikan No. KP anda betul atau daftar di Tab 1.');
                }

                generateCertificate(data);

                Swal.fire({
                    icon: 'success',
                    title: 'Sijil Ditemui',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });

            } catch (error) {
                console.error('Ralat Semakan:', error.message);
                Swal.fire({
                    icon: 'error',
                    title: 'Semakan Gagal',
                    text: error.message,
                });
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Cari';
            }
        });

        resetBtn.addEventListener('click', () => {
            nokpSemakInput.value = '';
            sijilContainer.innerHTML = '';
        });

        // Papar sijil dalam modal ala prototaip
        function generateCertificate(peserta) {
            sijilContainer.innerHTML = '';

            sijilContent.innerHTML = `
<div id="sijil-wrapper">
                
                    <div class="sijil-text" 
                         style="top: ${POSISI_NAMA}; 
                                font-family: Arial, sans-serif; 
                                line-height: 1.2;
								left:12%;
								width:94%">
                        
                        <div style="font-size: 32px; font-weight: bold;">
                            ${peserta.nama}
                        </div>
                        
                        <div style="font-size: 16px; font-style: italic;"> 
                            (${peserta.nokp})
                        </div>
                    </div>
                    </div>
            
            `;

            if (sijilModal) {
                sijilModal.style.display = 'block';
            }
        }

        // --- LOGIK TAB 3: RUMUSAN ---
        async function loadRumusan() {
            const loadingHtml = '<p class="text-gray-500">Memuatkan data rumusan...</p>';
            rumusanContainer.innerHTML = loadingHtml;
            rumusanGlobalContainer.innerHTML = loadingHtml;
            
            try {
                const { data, error } = await db
                    .from('peserta')
                    .select('negeri, peranan');

                if (error) throw error;

                const globalCounts = {};
                senaraiPeranan.forEach(peranan => {
                    globalCounts[peranan] = 0;
                });

                const negeriCounts = {};
                senaraiNegeri.forEach(negeri => {
                    negeriCounts[negeri] = {};
                    senaraiPeranan.forEach(peranan => {
                        negeriCounts[negeri][peranan] = 0;
                    });
                });

                data.forEach(row => {
                    const negeri = row.negeri;
                    const peranan = row.peranan;

                    if (!globalCounts[peranan]) {
                        globalCounts[peranan] = 0;
                    }
                    globalCounts[peranan]++;

                    if (negeriCounts[negeri] && negeriCounts[negeri][peranan] !== undefined) {
                        negeriCounts[negeri][peranan]++;
                    }
                });

                let globalHtml = '<div class="grid grid-cols-1 sm:grid-cols-3 gap-4">';
                senaraiPeranan.forEach(peranan => {
                    globalHtml += `
                        <div class="p-4 bg-white rounded-lg shadow border border-gray-200">
                            <h4 class="text-sm font-semibold text-gray-600">${peranan}</h4>
                            <p class="mt-2 text-3xl font-bold text-blue-600">${globalCounts[peranan] || 0}</p>
                        </div>
                    `;
                });
                globalHtml += '</div>';
                rumusanGlobalContainer.innerHTML = globalHtml;

                let negeriHtml = '';
                senaraiNegeri.forEach(negeri => {
                    const negeriData = negeriCounts[negeri];
                    const total = senaraiPeranan.reduce((sum, p) => sum + (negeriData[p] || 0), 0);
                    if (total === 0) return;

                    const maxPeranan = Math.max(...senaraiPeranan.map(p => negeriData[p] || 0));
                    const bgOpacity = Math.min(90, 30 + (maxPeranan / Math.max(1, total)) * 60);

                    negeriHtml += `
                        <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
                            <div class="p-4" style="background-color: rgba(37, 99, 235, ${bgOpacity / 100});">
                                <div class="p-4 ${bgOpacity > 50 ? 'text-white' : 'text-gray-900'}">
                                    <h4 class="text-lg font-bold">${negeri}</h4>
                                    <p class="text-3xl font-extrabold">${total}</p>
                                </div>
                                <div class="bg-gray-50 p-4 border-t ${bgOpacity > 50 ? 'text-gray-700' : ''}">
                                    <ul class="text-sm space-y-1">
                                        ${senaraiPeranan.map(peranan => `
                                            <li class="flex justify-between">
                                                <span>${namaPaparanPeranan[peranan] || peranan}</span>
                                                <span class="font-medium">${negeriData[peranan]}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                });
                rumusanContainer.innerHTML = negeriHtml || '<p class="text-gray-500">Tiada data untuk dipaparkan.</p>';
            } catch (error) {
                console.error('Ralat rumusan:', error.message);
                rumusanContainer.innerHTML = '<p class="text-red-500">Ralat memuatkan data rumusan.</p>';
                rumusanGlobalContainer.innerHTML = '<p class="text-red-500">Ralat memuatkan data rumusan.</p>';
            }
        }

        showTab('1');
    </script>
</body>
</html>
