<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem e-Sijil JPN Melaka</title>
	
	<link rel="icon" type="image/png" href="https://i.postimg.cc/jdp3yqpZ/logotech.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <!-- Oswald: ikut SOP, preconnect + preload -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Guna fon Oswald sebagai default */
        body {
            font-family: 'Oswald', sans-serif;
        }

        /* Paparan Sijil (Mesra Mudah Alih) */
        #sijil-wrapper {
            width: 100%;
            max-width: 210mm;
            aspect-ratio: 210 / 297;
            height: auto;
            position: relative;
            background-size: 100% 100%;    /* Kekal stretch */
            background-position: center;
            background-repeat: no-repeat;
            margin: 20px auto;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            /*
               Fail .png anda dikekalkan seperti dalam kod asal anda
            */
            background-image: url('./sijil_techlym.png?v=1');
        }

        .sijil-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-family: 'Times New Roman', Times, serif;
            color: black;
            padding: 0 10%;
            box-sizing: border-box;
        }

        /* --- PERUBAHAN CSS CETAK BERMULA DI SINI --- */

/* Tetapan khusus untuk paparan cetak A4 supaya imej sijil memenuhi halaman secara automatik */
@page {
    size: A4 portrait;
    margin: 0;
}

@media print {

    /* 1. Sembunyikan semua elemen secara lalai */
    body * {
        visibility: hidden;
    }

    /* 2. Sembunyikan bar butang cetak */
    #print-button-container {
        display: none !important;
    }

    /* 3. Pastikan kontena sijil dan kandungannya kelihatan */
    #sijil-container,
    #sijil-wrapper,
    #sijil-wrapper * {
        visibility: visible;
    }

    /* 4. Buang margin / padding / bayang dari parent supaya tidak ganggu saiz */
    html,
    body,
    .max-w-4xl,
    #tab-content-2,
    #sijil-container {
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
        box-shadow: none !important;
        width: 100%;
    }

    body {
        margin: 0 !important;
        padding: 0 !important;
    }

    /* 5. Jadikan sijil bersaiz tepat A4 dan isi penuh halaman */
    #sijil-wrapper {
        position: relative !important;
        width: 210mm !important;
        height: 297mm !important;
        max-width: none !important;
        aspect-ratio: auto;
        margin: 0 auto !important;
        box-shadow: none !important;
        background-size: 100% 100% !important;
        background-position: center center !important;
        background-repeat: no-repeat !important;
    }

    /* 6. Pastikan teks sijil kekal kelihatan (position: absolute) */
    .sijil-text {
        visibility: visible;
    }
}
/* --- PERUBAHAN CSS CETAK TAMAT DI SINI --- */
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
        
        <header>
            <img 
                src="https://i.postimg.cc/prwxDJJH/header-2024.png" 
                alt="Header JPN Melaka" 
                class="w-full">
        </header>

        <nav class="border-b border-gray-200 bg-gray-50">
            <div class="flex">
                <button 
                    id="tab-btn-1"
                    class="flex-1 py-3 px-4 text-center text-sm font-medium text-blue-600 bg-white border-b-2 border-blue-500 focus:outline-none">
                    Pendaftaran
                </button>
                <button 
                    id="tab-btn-2"
                    class="flex-1 py-3 px-4 text-center text-sm font-medium text-gray-600 hover:text-blue-600 hover:bg-gray-100 focus:outline-none">
                    Semak / Cetak Sijil
                </button>
                <button 
                    id="tab-btn-3"
                    class="flex-1 py-3 px-4 text-center text-sm font-medium text-gray-600 hover:text-blue-600 hover:bg-gray-100 focus:outline-none">
                    Rumusan Kehadiran
                </button>
            </div>
        </nav>

        <main class="p-6">
            <div id="tab-content-1" class="tab-content">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Pendaftaran Kehadiran</h2>
                
                <form id="borang-pendaftaran" class="space-y-4">
                    <div>
                        <label for="nama" class="block text-sm font-medium text-gray-700">Nama Penuh</label>
                        <input 
                            type="text" 
                            id="nama" 
                            name="nama" 
                            required 
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>

                    <div>
                        <label for="nokp" class="block text-sm font-medium text-gray-700">No. Kad Pengenalan</label>
                        <input 
                            type="text" 
                            id="nokp" 
                            name="nokp" 
                            required 
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>

                    <div>
                        <label for="sekolah" class="block text-sm font-medium text-gray-700">Nama Sekolah / Organisasi</label>
                        <input 
                            type="text" 
                            id="sekolah" 
                            name="sekolah" 
                            required 
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>

                    <div>
                        <label for="daerah" class="block text-sm font-medium text-gray-700">Daerah / Negeri</label>
                        <input 
                            type="text" 
                            id="daerah" 
                            name="daerah" 
                            required 
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>

                    <div class="flex items-center space-x-3 pt-4">
                        <button 
                            type="submit" 
                            class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            Hantar Pendaftaran
                        </button>
                        <button 
                            type="reset" 
                            class="inline-flex justify-center py-2 px-6 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            Reset
                        </button>
                    </div>
                </form>
                
                <div id="sijil-container" class="mt-6">
                    </div>
            </div>

            <div id="tab-content-3" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Rumusan Kehadiran</h2>
                
                <div id="rumusan-global-container" class="mb-8 p-6 bg-gray-50 rounded-lg shadow-inner">
                    <h3 class="text-xl font-bold mb-4">Rumusan Keseluruhan</h3>
                    </div>

                <div>
                    <h3 class="text-xl font-bold mb-4">Senarai Peserta</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bil</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. KP</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sekolah / Organisasi</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Daerah / Negeri</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Masa Daftar</th>
                                </tr>
                            </thead>
                            <tbody id="senarai-peserta" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-content-2" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Semak dan Cetak Sijil</h2>
                
                <form id="borang-semak" class="space-y-4">
                    <div>
                        <label for="semak-nokp" class="block text-sm font-medium text-gray-700">Masukkan No. Kad Pengenalan</label>
                        <input 
                            type="text" 
                            id="semak-nokp" 
                            name="semak-nokp" 
                            required 
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>

                    <div class="flex items-center space-x-3 pt-4">
                        <button 
                            type="submit" 
                            class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                            Semak Sijil
                        </button>
                        <button 
                            type="reset" 
                            class="inline-flex justify-center py-2 px-6 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            Reset
                        </button>
                    </div>
                </form>

                <div id="hasil-semak" class="mt-6">
                    </div>
            </div>
        </main>

        <footer class="bg-gray-50 border-t border-gray-200 p-4 text-center text-xs text-gray-500">
            Sistem e-Sijil JPN Melaka
        </footer>
    </div>

    <script>
        const supabaseUrl = "https://irgngpkitgzvvoqzqrsn.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlyZ25ncGtpdGd6dnZvcXpxcnNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA2ODM3NTcsImV4cCI6MjA0NjI1OTc1N30.9H1Nu3mf-aEMhub6pH0O6VlBUo5dwiboxLSfHt5iy68";
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        function tunjukSwal(icon, title, text) {
            Swal.fire({
                icon,
                title,
                text,
                confirmButtonText: 'OK',
                customClass: {
                    title: 'font-oswald',
                    confirmButton: 'font-oswald'
                }
            });
        }

        const tabButtons = {
            btn1: document.getElementById('tab-btn-1'),
            btn2: document.getElementById('tab-btn-2'),
            btn3: document.getElementById('tab-btn-3')
        };

        const tabContents = {
            content1: document.getElementById('tab-content-1'),
            content2: document.getElementById('tab-content-2'),
            content3: document.getElementById('tab-content-3')
        };

        function showTab(tabId) {
            Object.values(tabContents).forEach(el => el.classList.add('hidden'));
            Object.values(tabButtons).forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600', 'bg-white');
                btn.classList.add('text-gray-600');
            });

            if (tabId === '1') {
                tabContents.content1.classList.remove('hidden');
                tabButtons.btn1.classList.add('border-blue-500', 'text-blue-600', 'bg-white');
            } else if (tabId === '2') {
                tabContents.content2.classList.remove('hidden');
                tabButtons.btn2.classList.add('border-blue-500', 'text-blue-600', 'bg-white');
            } else if (tabId === '3') {
                tabContents.content3.classList.remove('hidden');
                tabButtons.btn3.classList.add('border-blue-500', 'text-blue-600', 'bg-white');
                muatRumusan();
            }
        }

        document.getElementById('borang-pendaftaran').addEventListener('submit', async (e) => {
            e.preventDefault();

            const nama = document.getElementById('nama').value.trim();
            const nokp = document.getElementById('nokp').value.trim();
            const sekolah = document.getElementById('sekolah').value.trim();
            const daerah = document.getElementById('daerah').value.trim();

            if (!nama || !nokp || !sekolah || !daerah) {
                tunjukSwal('warning', 'Peringatan', 'Sila lengkapkan semua maklumat.');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('peserta')
                    .upsert([
                        {
                            nokp: nokp,
                            nama: nama,
                            sekolah: sekolah,
                            daerah: daerah
                        }
                    ], { onConflict: 'nokp' });

                if (error) {
                    console.error(error);
                    tunjukSwal('error', 'Ralat', 'Pendaftaran gagal. Sila cuba lagi.');
                    return;
                }

                tunjukSwal('success', 'Berjaya', 'Pendaftaran berjaya dihantar.');
                e.target.reset();
            } catch (err) {
                console.error(err);
                tunjukSwal('error', 'Ralat', 'Berlaku ralat sambungan. Sila cuba lagi.');
            }
        });

        document.getElementById('borang-semak').addEventListener('submit', async (e) => {
            e.preventDefault();

            const nokp = document.getElementById('semak-nokp').value.trim();

            if (!nokp) {
                tunjukSwal('warning', 'Peringatan', 'Sila masukkan No. Kad Pengenalan.');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('peserta')
                    .select('*')
                    .eq('nokp', nokp)
                    .single();

                if (error || !data) {
                    tunjukSwal('error', 'Tidak Dijumpai', 'Rekod tidak dijumpai. Sila semak semula No. KP.');
                    document.getElementById('hasil-semak').innerHTML = '';
                    return;
                }

                janaSijil(data);
            } catch (err) {
                console.error(err);
                tunjukSwal('error', 'Ralat', 'Berlaku ralat sambungan. Sila cuba lagi.');
            }
        });

        async function muatRumusan() {
            try {
                const { data, error } = await supabaseClient
                    .from('peserta')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (error) {
                    console.error(error);
                    tunjukSwal('error', 'Ralat', 'Gagal memuatkan rumusan.');
                    return;
                }

                const totalPeserta = data.length;

                const rumusanGlobalContainer = document.getElementById('rumusan-global-container');
                rumusanGlobalContainer.innerHTML = `
                    <p class="text-sm text-gray-700 mb-2">
                        Jumlah peserta berdaftar: <span class="font-bold">${totalPeserta}</span>
                    </p>
                `;

                const senaraiPesertaTbody = document.getElementById('senarai-peserta');
                senaraiPesertaTbody.innerHTML = '';

                data.forEach((peserta, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-3 py-2 text-sm text-gray-700">${index + 1}</td>
                        <td class="px-3 py-2 text-sm text-gray-700">${peserta.nama}</td>
                        <td class="px-3 py-2 text-sm text-gray-700">${peserta.nokp}</td>
                        <td class="px-3 py-2 text-sm text-gray-700">${peserta.sekolah}</td>
                        <td class="px-3 py-2 text-sm text-gray-700">${peserta.daerah}</td>
                        <td class="px-3 py-2 text-sm text-gray-700">${new Date(peserta.created_at).toLocaleString('ms-MY')}</td>
                    `;
                    senaraiPesertaTbody.appendChild(tr);
                });

            } catch (err) {
                console.error(err);
                tunjukSwal('error', 'Ralat', 'Berlaku ralat sambungan semasa memuatkan rumusan.');
            }
        }

        function janaSijil(peserta) {
            const hasilSemakDiv = document.getElementById('hasil-semak');
            const sijilContainer = document.getElementById('sijil-container');

            const POSISI_NAMA = "38%";
            const POSISI_NOKP = "44%";
            const POSISI_SEKOLAH = "52%";
            const POSISI_DAERAH = "58%";

            hasilSemakDiv.innerHTML = `
                <div class="mb-4 p-4 bg-green-50 border-l-4 border-green-400">
                    <h3 class="text-lg font-semibold text-green-700 mb-1">Rekod Dijumpai</h3>
                    <p class="text-sm text-gray-700">
                        Sijil untuk <span class="font-bold">${peserta.nama}</span> telah dijana. 
                        Sila tatal ke bawah untuk pratonton dan cetak sijil.
                    </p>
                </div>
            `;

            sijilContainer.innerHTML = `
                <div class="flex justify-center mb-4" id="print-button-container">
                    <button id="print-button" class="py-2 px-6 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 transition duration-150">
                        Cetak / Simpan PDF
                    </button>
                </div>
                <div id="sijil-wrapper">
                
                    <div class="sijil-text" 
                         style="top: ${POSISI_NAMA}; 
                                font-family: Arial, sans-serif; 
                                line-height: 1.2;
								left:12%;
								width:94%">
                        
                        <div style="font-size: 32px; font-weight: bold;">
                            ${peserta.nama.toUpperCase()}
                        </div>
                    </div>

                    <div class="sijil-text" 
                         style="top: ${POSISI_NOKP}; 
                                font-family: Arial, sans-serif; 
                                font-size: 14px;
								left:12%;
								width:94%">
                        <div>
                            (${peserta.nokp})
                        </div>
                    </div>

                    <div class="sijil-text" 
                         style="top: ${POSISI_SEKOLAH}; 
                                font-family: Arial, sans-serif; 
                                font-size: 18px;
								left:12%;
								width:94%">
                        <div>
                            ${peserta.sekolah.toUpperCase()}
                        </div>
                    </div>

                    <div class="sijil-text" 
                         style="top: ${POSISI_DAERAH}; 
                                font-family: Arial, sans-serif; 
                                font-size: 18px;
								left:12%;
								width:90%">
                        <div>
                            ${peserta.daerah.toUpperCase()}
                        </div>
                    </div>

                </div>
            `;

            const printButton = document.getElementById('print-button');
            if (printButton) {
                printButton.addEventListener('click', () => {
                    window.print();
                });
            }
        }

        tabButtons.btn1.addEventListener('click', () => showTab('1'));
        tabButtons.btn2.addEventListener('click', () => showTab('2'));
        tabButtons.btn3.addEventListener('click', () => showTab('3'));

        showTab('1');
    </script>
</body>
</html>
